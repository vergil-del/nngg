import cron from "node-cron";
import fs from "fs-extra";
import moment from "moment-timezone";

// ğŸ•’ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
const TIMEZONE = "Africa/Khartoum";

// ğŸ“œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ø¹ÙŠØ© ÙˆØ§Ù„Ø£Ø°ÙƒØ§Ø±
const messages = [
  "ğŸ¤² Ø§Ù„Ù„Ù‡Ù… Ø§Ø±Ø²Ù‚Ù†Ø§ Ø­ÙØ³Ù† Ø§Ù„Ø®Ø§ØªÙ…Ø©.",
  "ğŸ•Šï¸ Ø§Ù„Ù„Ù‡Ù… ØµÙ„ ÙˆØ³Ù„Ù… Ø¹Ù„Ù‰ Ø³ÙŠØ¯Ù†Ø§ Ù…Ø­Ù…Ø¯.",
  "ğŸ’– Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±.",
  "ğŸŒ™ Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡ØŒ Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ….",
  "ğŸ“¿ Ø§Ù„Ù„Ù‡Ù… Ø§Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø´Ø§Ù‡Ø¯Ù‹Ø§ Ù„Ù†Ø§ Ù„Ø§ Ø¹Ù„ÙŠÙ†Ø§.",
  "ğŸ•Œ Ø§Ù„Ù„Ù‡Ù… Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø±Ø¨ÙŠØ¹ Ù‚Ù„ÙˆØ¨Ù†Ø§ ÙˆÙ†ÙˆØ± ØµØ¯ÙˆØ±Ù†Ø§.",
  "âœ¨ Ø§Ù„Ù„Ù‡Ù… Ø§Ø±Ø²Ù‚Ù†Ø§ ØªÙˆØ¨Ø©Ù‹ Ù„Ø§ Ù†Ù†ØªÙƒØ³ Ø¨Ø¹Ø¯Ù‡Ø§ Ø£Ø¨Ø¯Ù‹Ø§.",
  "ğŸŒ¸ Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ… Ø§Ù„Ø°ÙŠ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ù‡Ùˆ Ø§Ù„Ø­ÙŠ Ø§Ù„Ù‚ÙŠÙˆÙ… ÙˆØ£ØªÙˆØ¨ Ø¥Ù„ÙŠÙ‡.",
  "ğŸ’« Ø§Ù„Ù„Ù‡Ù… ØµÙ„ ÙˆØ³Ù„Ù… Ø¹Ù„Ù‰ Ù†Ø¨ÙŠÙ†Ø§ Ù…Ø­Ù…Ø¯ Ø¹Ø¯Ø¯ Ù…Ø§ Ø°ÙƒØ±Ù‡ Ø§Ù„Ø°Ø§ÙƒØ±ÙˆÙ† ÙˆØºÙÙ„ Ø¹Ù† Ø°ÙƒØ±Ù‡ Ø§Ù„ØºØ§ÙÙ„ÙˆÙ†.",
  "ğŸŒ¤ï¸ Ø§Ù„Ù„Ù‡Ù… Ø§Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù…Ù„ÙŠØ¦Ù‹Ø§ Ø¨Ø§Ù„Ø®ÙŠØ± ÙˆØ§Ù„Ø¨Ø±ÙƒØ© ÙˆØ§Ù„Ø³Ø¹Ø§Ø¯Ø©."
];

// ğŸ“‚ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
const GROUPS_FILE = './data/groups.json';

// Ø¬Ù„Ø¨ ÙƒÙ„ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
const getAllGroupIDs = async () => {
  if (!fs.existsSync(GROUPS_FILE)) return [];
  try {
    const data = JSON.parse(fs.readFileSync(GROUPS_FILE));
    return Object.keys(data);
  } catch {
    return [];
  }
};

// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
export default async function startHourlyDuaSender(api) {
  cron.schedule("0 * * * *", async () => {
    const now = moment().tz(TIMEZONE).format("HH:mm");
    const msg = messages[Math.floor(Math.random() * messages.length)];

    const groupIDs = await getAllGroupIDs();
    for (const threadID of groupIDs) {
      api.sendMessage(`ğŸ•’ ${now} - ${msg}`, threadID);
    }

    console.log(`[âœ”] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¹Ø© ${now} Ø¥Ù„Ù‰ ${groupIDs.length} Ù…Ø¬Ù…ÙˆØ¹Ø©.`);
  }, {
    timezone: TIMEZONE
  });

  console.log("[âœ”] ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø©.");
}
